<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- VIEWS -->

   <record id="view_credit_request_tree" model="ir.ui.view">
        <field name="name">farmerscredit.credit.request.tree</field>
        <field name="model">farmerscredit.credit.request</field>
        <field name="priority">4</field>
        <field name="arch" type="xml">
            <tree string="Credit Request" class="o_sale_order" sample="1"
                decoration-info="state in ['request', 'authorized', 'contract']"
                decoration-muted="state == 'cancel'">
                <field name="name" string="Number" readonly="1" decoration-bf="1"/>
                <field name="create_date" string="Creation Date" widget="date" optional="show"/>
                <field name="commitment_date" widget="date" optional="hide"/>
                <field name="partner_id" readonly="1"/>
                <field name="user_id" widget="many2one_avatar_user" optional="show"/>
                <field name="activity_ids" widget="list_activity" optional="show"/>
                <field name="team_id" optional="hide"/>
                <field name="company_id" groups="base.group_multi_company" optional="show" readonly="1"/>
                <field name="amount_untaxed" sum="Total Tax Excluded" widget="monetary" optional="hide"/>
                <field name="amount_tax" sum="Tax Total" widget="monetary" optional="hide"/>
                <field name="amount_total" sum="Total Tax Included" widget="monetary" decoration-bf="1" optional="show"/>
                <field name="state"
                    decoration-success="state == 'authorized' or state == 'contract'"
                    decoration-info="state == 'request'"
                    widget="badge" optional="show"/>
                <field name="message_needaction" invisible="1"/>
                <field name="currency_id" invisible="1"/>
            </tree>
        </field>
    </record>

    <record id="view_credit_request_calendar" model="ir.ui.view">
        <field name="name">farmerscredit.credit.request.calendar</field>
        <field name="model">farmerscredit.credit.request</field>
        <field name="arch" type="xml">
            <calendar string="Credit Requests" date_start="request_date" color="state" hide_time="true" event_limit="5">
                <field name="currency_id" invisible="1"/>
                <field name="partner_id" avatar_field="avatar_128"/>
                <field name="amount_total" widget="monetary"/>
                <field name="payment_term_id"/>
                <field name="state" filters="1" invisible="1"/>
            </calendar>
        </field>
    </record>

    <record id="view_credit_request_graph" model="ir.ui.view">
        <field name="name">farmerscredit.credit.request.graph</field>
        <field name="model">farmerscredit.credit.request</field>
        <field name="arch" type="xml">
            <graph string="Credit Requests" sample="1">
                <field name="partner_id"/>
                <field name="amount_total" type="measure"/>
            </graph>
        </field>
    </record>

    <record id="view_credit_request_pivot" model="ir.ui.view">
        <field name="name">farmerscredit.credit.request.pivot</field>
        <field name="model">farmerscredit.credit.request</field>
        <field name="arch" type="xml">
            <pivot string="Credit Requests" sample="1">
                <field name="request_date" type="row"/>
                <field name="amount_total" type="measure"/>
            </pivot>
        </field>
    </record>

    <record id="view_credit_request_kanban" model="ir.ui.view">
        <field name="name">farmerscredit.credit.request.kanban</field>
        <field name="model">farmerscredit.credit.request</field>
        <field name="arch" type="xml">
            <kanban class="o_kanban_mobile" sample="1">
                <field name="name"/>
                <field name="partner_id"/>
                <field name="amount_total"/>
                <field name="request_date"/>
                <field name="state"/>
                <field name="currency_id"/>
                 <templates>
                    <t t-name="kanban-box">
                        <div t-attf-class="oe_kanban_card oe_kanban_global_click">
                            <div class="o_kanban_record_top mb16">
                                <div class="o_kanban_record_headings mt4">
                                    <strong class="o_kanban_record_title">
                                        <span t-out="record.partner_id.value"/>
                                    </strong>
                                </div>
                                <strong>
                                    <field name="amount_total" widget="monetary"/>
                                </strong>
                            </div>
                            <div class="o_kanban_record_bottom">
                                <div class="oe_kanban_bottom_left text-muted">
                                    <span>
                                        <t t-out="record.name.value"/> <t t-out="record.date_order.value"/>
                                    </span>
                                </div>
                                <div class="oe_kanban_bottom_right">
                                    <field name="state"
                                        widget="label_selection"
                                        options="{'classes': {'draft': 'default', 'cancel': 'default', 'done': 'success'}}"/>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>


    <record id="view_credit_request_form" model="ir.ui.view">
        <field name="name">farmerscredit.credit.request.form</field>
        <field name="model">farmerscredit.credit.request</field>
        <field name="arch" type="xml">
            <form string="Credit Request" class="o_sale_order">
            <header>
               <button name="action_confirm" id="action_confirm" data-hotkey="v"
                    string="Confirm" class="btn-primary" type="object" context="{'validate_analytic': True}"
                    attrs="{'invisible': [('state', 'not in', ['authorized','contract'])]}"/>
                <button name="action_confirm" data-hotkey="v"
                    string="Confirm" type="object" context="{'validate_analytic': True}"
                    attrs="{'invisible': [('state', 'not in', ['request'])]}"/>
                <button name="action_cancel" type="object" string="Cancel" attrs="{'invisible': ['|', ('state', 'not in', ['request', 'cancel']), ('id', '=', False)]}" data-hotkey="z"/>
                <button name="action_draft" states="cancel" type="object" string="Set to Credit Request" data-hotkey="w"/>
                <field name="ministering_count" invisible="1" />
                <field name="lines_count" invisible="1" />
                <button name="action_create_ministering" id="action_create_ministering" type="object"
                        string="Create Ministering" class="btn-primary"
                        attrs="{'invisible': ['|', ('lines_count', '=', 0), '|', 
                                            ('state', 'in', ['authorized', 'contract']), 
                                            ('ministering_count', '!=', 0)]}"
                />                
                <field name="state" widget="statusbar" statusbar_visible="request,authorized,contract"/>
            </header>
            <div groups="account.group_account_invoice,account.group_account_readonly"
                 class="alert alert-warning mb-0" role="alert"
                 attrs="{'invisible': [('partner_credit_warning', '=', '')]}">
                <field name="partner_credit_warning"/>
            </div>
            <sheet>
                <div class="oe_title">
                    <h1>
                        <field name="name"/>
                        <field name="require_signature" invisible="1" />
                    </h1>
                </div>
                <group name="credit_request_header">
                    <group name="partner_details">
                        <field name="partner_id" widget="res_partner_many2one" context="{'res_partner_search_mode': 'customer', 'show_address': 1, 'show_vat': True}" options='{"always_reload": True}'/>
                        <field name="partner_endorsement_id"  context="{'default_type':'private'}" options='{"always_reload": True}'/>
                   </group>
                    <group name="credit_request_details">
                        <field name="request_date"/>
                        <field name="commitment_date" />
                        <field name="company_id" invisible="1"/>
                        <field name="currency_id" invisible="1"/>
                        <field name="payment_term_id" options="{'no_open':True,'no_create': True}" invisible="1" />
                    </group>
                </group>
                <notebook>
                    <page string="Planting Program" name="plating_program_lines">
                        <field
                            name="credit_request_line"
                            mode="tree"
                            attrs="{'readonly': [('state', 'not in', ('request'))]}"
                            context="{'default_request_id': active_id}"
                        >
                            <tree editable="bottom" string="Crop/Season">
                                <field name="crop_id" />
                                <field name="season_id" />
                                <field name="credit_per_unit" />
                                <field name="quota_per_unit" />
                                <field name="area" sum="Total"/>
                                <field name="credit_amount" sum="Total"/>
                            </tree>
                        </field>
                    </page>
                    <page string="Personal References" name="personal_reference_lines">
                        <field
                            name="personal_ref_ids"
                            mode="tree"
                            attrs="{'readonly': [('state', 'not in', ('request'))]}"
                            context="{ 
                                    'default_request_id': active_id,
                                    'default_is_personal': True,
                                 }"
                        >
                            <tree editable="bottom" string="Personal References">
                                <field name="name" />
                                <field name="telephone" widget="phone" />
                                <field name="relationship" />
                                <field name="is_personal" invisible="1"/>
                            </tree>
                        </field>
                    </page>
                    <page string="Commercial References" name="commercial_reference_lines">
                        <field
                            name="commercial_ref_ids"
                            mode="tree"
                            attrs="{'readonly': [('state', 'not in', ('request'))]}"
                            context="{
                                        'default_request_id': active_id,
                                        'default_is_personal': False,
                                   }"
                        >
                            <tree editable="bottom" string="Commercial References">
                                <field name="name" />
                                <field name="telephone" widget="phone" />
                                <field name="relationship" />
                                <field name="is_personal" invisible="1"/>
                            </tree>
                        </field>
                    </page>
                    <page string="Guarantees" name="guarantee_lines">
                        <field
                            name="guarantees_ids"
                            domain="[('partner_id', '=', partner_id)]"
                            widget="many2many"
                            attrs="{'readonly': [('state', 'not in', ('request'))]}"
                        >
                            <tree editable="bottom" string="Guarantees">
                                <field name="name" />
                                <field name="estimated_value" sum="Total" readonly="1" />
                                <field name="owner" readonly="1" />
                            </tree>
                        </field>
                    </page>                    
                    <page string="Ministering" name="ministering_operations">
                        <group>
                            <group>
                                <field name="ministering_ids">
                                    <tree editable="bottom">
                                        <field name="date_ministering" />
                                        <field name="credit_granted" sum="Total" />
                                    </tree>
                                </field>
                            </group>
                        </group>
                    </page>
                    <page groups="base.group_no_one" string="Customer Signature" name="customer_signature" attrs="{'invisible': [('require_signature', '=', False), ('signed_by', '=', False), ('signature', '=', False), ('signed_on', '=', False)]}">
                        <group>
                            <field name="signed_by"/>
                            <field name="signed_on"/>
                            <field name="signature" widget="image"/>
                        </group>
                    </page>
                </notebook>
            </sheet>
                <div class="oe_chatter">
                    <field name="message_follower_ids"/>
                    <field name="activity_ids"/>
                    <field name="message_ids"/>
                </div>
            </form>
        </field>
    </record>

    <record id="view_credit_request_filter" model="ir.ui.view">
        <field name="name"> farmerscredit.credit.request.list.select</field>
        <field name="model">farmerscredit.credit.request</field>
        <field name="priority" eval="15"/>
        <field name="arch" type="xml">
            <search string="Search Credit Request">
                <field name="name" string="Order"
                    filter_domain="['|', '|', ('name', 'ilike', self), ('client_order_ref', 'ilike', self), ('partner_id', 'child_of', self)]"/>
                <field name="partner_id" operator="child_of"/>
                <field name="user_id"/>
                <field name="team_id" string="Sales Team"/>
          </search>
        </field>
    </record>

    <!-- ACTIONS (WINDOW) -->

    <record id="action_credit_request" model="ir.actions.act_window">
        <field name="name">Credit Request</field>
        <field name="type">ir.actions.act_window</field>
        <field name="res_model">farmerscredit.credit.request</field>
        <field name="view_mode">tree,kanban,form,calendar,pivot,graph</field>
        <field name="search_view_id" ref="view_credit_request_filter"/>
        <field name="context">{}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Create a new Credit Request, the first step for a new Credit!
            </p><p>
                Once the Credit Request is confirmed, it becomes a Contract.<br/> You will be able to create an Sales Orders and Invoices and collect the payment.
            </p>
        </field>
    </record>

    <record id="credit_request_action_view_tree" model="ir.actions.act_window.view">
        <field name="sequence" eval="1"/>
        <field name="view_mode">tree</field>
        <field name="view_id" ref="farmerscredit.view_credit_request_tree"/>
        <field name="act_window_id" ref="action_credit_request"/>
    </record>

    <record id="credit_request_action_view_kanban" model="ir.actions.act_window.view">
        <field name="sequence" eval="2"/>
        <field name="view_mode">kanban</field>
        <field name="view_id" ref="farmerscredit.view_credit_request_kanban"/>
        <field name="act_window_id" ref="action_credit_request"/>
    </record>

    <record id="credit_request_action_view_form" model="ir.actions.act_window.view">
        <field name="sequence" eval="3"/>
        <field name="view_mode">form</field>
        <field name="view_id" ref="farmerscredit.view_credit_request_form"/>
        <field name="act_window_id" ref="action_credit_request"/>
    </record>

    <record id="credit_request_action_view_calendar" model="ir.actions.act_window.view">
        <field name="sequence" eval="4"/>
        <field name="view_mode">calendar</field>
        <field name="view_id" ref="farmerscredit.view_credit_request_calendar"/>
        <field name="act_window_id" ref="action_credit_request"/>
    </record>

    <record id="credit_request_action_view_pivot" model="ir.actions.act_window.view">
        <field name="sequence" eval="5"/>
        <field name="view_mode">pivot</field>
        <field name="view_id" ref="farmerscredit.view_credit_request_pivot"/>
        <field name="act_window_id" ref="action_credit_request"/>
    </record>

    <record id="credit_request_action_view_graph" model="ir.actions.act_window.view">
        <field name="sequence" eval="6"/>
        <field name="view_mode">graph</field>
        <field name="view_id" ref="farmerscredit.view_credit_request_graph"/>
        <field name="act_window_id" ref="action_credit_request"/>
    </record>


    <!-- menu categories -->
    <menuitem name="Operations" id="farmerscredit.operations" 
                parent="farmerscredit.menu_root"
                sequence="05"/>
  
    <!-- actions -->
    <menuitem name="Credit Request" id="farmerscredit.credit_request_list" parent="farmerscredit.operations"
              sequence="05"
              action="action_credit_request"/>
</odoo>
